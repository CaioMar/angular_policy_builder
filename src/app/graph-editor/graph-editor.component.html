<div class="container" style="display:flex;align-items:flex-start;height:100%;min-height:400px;gap:0">
  <div class="left-pane" style="flex:1;min-width:0;padding-right:12px">
    <div class="controls">
      <div id="cy" #cyContainer (drop)="onDrop($event)" (dragover)="onDragOver($event)"></div>
      <!-- SVG overlay used to draw a live edge while dragging -->
      <svg class="edge-overlay" [style.display]="isEdgeDragging ? 'block' : 'none'">
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L10,5 L0,10 z" fill="#0073bb" />
          </marker>
        </defs>
        <line [attr.x1]="getDragLineStart().x" [attr.y1]="getDragLineStart().y" [attr.x2]="dragCurrent.x" [attr.y2]="dragCurrent.y" stroke="#0073bb" stroke-width="2" marker-end="url(#arrow)" />
      </svg>
      <!-- small settings gear in the canvas (discrete) -->
      <div class="cy-settings" style="position:absolute;right:18px;top:14px;z-index:190;">
        <button title="Canvas settings" (click)="toggleCanvasSettings($event)" style="background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,0.06);color:#999;font-size:16px;">
          ‚öô
        </button>
        <div *ngIf="canvasSettingsVisible" style="position:absolute;right:0;top:38px;background:#fff;border:1px solid #ddd;box-shadow:0 6px 20px rgba(0,0,0,0.12);padding:10px;border-radius:6px;min-width:220px;z-index:200">
          <div style="font-weight:600;margin-bottom:6px">Canvas Settings</div>
          <div style="margin-bottom:8px;font-size:13px">
            <label style="display:block;margin-bottom:4px">Background</label>
            <select [(ngModel)]="bgPattern" (ngModelChange)="applyBackground()" style="width:100%">
              <option value="plain">Plain</option>
              <option value="dots">Dotted</option>
              <option value="grid">Grid</option>
            </select>
          </div>
          <div style="margin-bottom:8px;font-size:13px;">
            <label style="display:block;margin-bottom:4px">Background Color</label>
            <input type="color" [(ngModel)]="bgColor" (ngModelChange)="applyBackground()" style="width:40px;height:30px;padding:0;border:0;background:transparent" />
          </div>
          <div style="margin-bottom:8px;font-size:13px">
            <label style="display:block;margin-bottom:4px">Zoom level</label>
            <input type="range" min="0.2" max="3" step="0.01" [(ngModel)]="zoomLevel" (ngModelChange)="setZoomLevel($event)" style="width:100%" />
            <div style="font-size:12px;color:#666;margin-top:4px">{{zoomLevel | number:'1.2-2'}}√ó</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Metadata / details below the canvas -->
    <div class="metadata" style="margin-top:12px;border-top:1px solid #eee;padding-top:8px">
      <div *ngIf="selectedNode">
        <div class="meta-title" style="font-size:15px;font-weight:600;padding-bottom:6px">Node</div>
        <div style="font-size:13px;color:#333;margin-top:6px">Id: {{selectedNode.id}}</div>
        <div style="font-size:13px;color:#333">Label: {{selectedNode.label}}</div>
        <div style="font-size:13px;color:#333">Type: {{selectedNode.type}}</div>
        <div *ngIf="selectedNode.type !== 'leaf'" style="font-size:13px;color:#333">Expr: {{selectedNode.expr}}</div>
        <div *ngIf="selectedNode.type === 'leaf'" style="font-size:13px;color:#333">Output: {{selectedNode.label}}</div>
      </div>
      <div *ngIf="selectedEdge" style="margin-top:6px">
        <div class="meta-title" style="font-size:15px;font-weight:600;padding-bottom:6px">Edge</div>
        <div style="font-size:13px;color:#333;margin-top:6px">Id: {{selectedEdge.id}}</div>
        <div style="font-size:13px;color:#333">From: {{selectedEdge.source}} ‚Üí To: {{selectedEdge.target}}</div>
        <div style="font-size:13px;color:#333">Label: {{selectedEdge.label}}</div>
        <div *ngIf="selectedEdge.condition" style="font-size:13px;color:#333">Condition: {{selectedEdge.condition.op}} {{selectedEdge.condition.value}}</div>
      </div>
      <div *ngIf="!selectedNode && !selectedEdge && lastSelectionSnapshot" style="font-size:13px;color:#333">
        <div *ngIf="lastSelectionSnapshot.kind === 'node'" class="meta-title last-selected" style="font-size:15px;font-weight:700;padding-bottom:6px">Node</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'edge'" class="meta-title last-selected" style="font-size:15px;font-weight:700;padding-bottom:6px">Edge</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'node'">Id: {{lastSelectionSnapshot.data.id}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'node'">Label: {{lastSelectionSnapshot.data.label}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'node'">Type: {{lastSelectionSnapshot.data.type}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'node' && lastSelectionSnapshot.data.type !== 'leaf'">Expr: {{lastSelectionSnapshot.data.expr}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'edge'">Id: {{lastSelectionSnapshot.data.id}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'edge'">From: {{lastSelectionSnapshot.data.source}} ‚Üí To: {{lastSelectionSnapshot.data.target}}</div>
        <div *ngIf="lastSelectionSnapshot.kind === 'edge'">Label: {{lastSelectionSnapshot.data.label}}</div>
      </div>
      <div *ngIf="!selectedNode && !selectedEdge && !lastSelectionSnapshot" style="font-size:13px;color:#666">Click a node or an edge to see metadata here.</div>
    </div>
  </div>

  <!-- resizer between panes -->
  <div class="resizer" (mousedown)="startResizerDrag($event)" style="flex:0 0 8px;cursor:col-resize;background:transparent;user-select:none"></div>

  <div class="right-pane" [style.width.px]="rightPaneWidth" style="flex:0 0 auto;min-width:220px;max-width:720px;overflow:auto;padding-left:12px">
    <!-- toolbar moved into panel -->
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      <button (click)="addNode()" style="width:100%;padding:10px 12px">Add Node</button>
      <button (click)="deleteSelected()" [disabled]="!selectedNode" style="width:100%;padding:10px 12px">Delete Node</button>
    </div>
    <!-- Conflict modal -->
    <div class="conflict-modal" *ngIf="conflictModalVisible" style="position:fixed;left:50%;top:120px;transform:translateX(-50%);background:#fff;border:1px solid #ccc;padding:12px;z-index:160;box-shadow:0 6px 20px rgba(0,0,0,0.12);width:360px;">
      <h4 style="margin:0 0 8px 0">Conflicting Condition</h4>
      <div style="font-size:13px;color:#333">This condition conflicts with an existing one from the same source. Choose an action:</div>
      <ul style="margin:8px 0;padding-left:18px;font-size:13px;color:#333">
        <li *ngFor="let e of conflictingEdges">Edge {{e.id}} ‚Üí {{e.target}} : {{e.label}}</li>
      </ul>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button (click)="replaceConflictsAndConfirm()">Replace</button>
        <button (click)="cancelConflictModal()">Cancel</button>
      </div>
    </div>

    <div *ngIf="selectedEdge" style="border:1px solid #ddd;padding:8px;margin-bottom:12px;background:#fff">
      <h4>Edit Edge</h4>
      <div>
        <label>Id: {{selectedEdge.id}}</label>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <label>Condition</label>
        <select [(ngModel)]="selectedEdge.condition.op" *ngIf="selectedEdge.condition">
          <option value="==">==</option>
          <option value="!=">!=</option>
          <option value=">">&gt;</option>
          <option value=">=">&gt;=</option>
          <option value="<">&lt;</option>
          <option value="<=">&lt;=</option>
          <option value="in">in</option>
          <option value="contains">contains</option>
        </select>
        <input *ngIf="selectedEdge.condition" [(ngModel)]="selectedEdge.condition.value" placeholder="value" style="flex:1" />
      </div>
      <div style="margin-top:8px">
        <label>Label</label>
        <input [(ngModel)]="selectedEdge.label" style="width:100%" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button (click)="updateSelectedEdge()">Save</button>
        <button (click)="cancelEdgeEdit()">Cancel</button>
      </div>
    </div>

    <div *ngIf="selectedNode">
      <h4>Edit Node</h4>
      <label>Id: {{selectedNode.id}}</label>
      <div>
        <label>Label</label>
        <input [(ngModel)]="selectedNode.label" (ngModelChange)="updateSelectedNode()" />
      </div>
      <div>
        <label>Type</label>
        <select [(ngModel)]="selectedNode.type">
          <option value="condition">condition</option>
          <option value="action">action</option>
          <option value="leaf">leaf</option>
        </select>
      </div>
      <div *ngIf="selectedNode.type !== 'leaf'">
        <label>Expression</label>
        <input [(ngModel)]="selectedNode.expr" />
      </div>
      <div *ngIf="selectedNode.type === 'leaf'" style="margin-top:8px">
        <label>Output value</label>
        <input [(ngModel)]="selectedNode.label" (ngModelChange)="updateSelectedNode()" />
      </div>
    </div>

    <div style="margin-top:12px">
      <div *ngIf="edgeDraft" style="border:1px solid #ddd;padding:8px;margin-bottom:12px;background:#fbfbfb">
        <h4>Create Edge</h4>
        <div>
          <label>From:</label> <strong>{{edgeDraft.source}} ({{edgeDraft.parentVar}})</strong>
        </div>
        <div>
          <label>To:</label> <strong>{{ edgeDraft.isLeaf ? '(leaf)' : edgeDraft.target }}</strong>
        </div>
        <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
          <label>Condition</label>
          <select [(ngModel)]="edgeDraft.op">
            <option value="==">==</option>
            <option value="!=">!=</option>
            <option value=">">&gt;</option>
            <option value=">=">&gt;=</option>
            <option value="<">&lt;</option>
            <option value="<=">&lt;=</option>
            <option value="in">in</option>
            <option value="contains">contains</option>
          </select>
          <input *ngIf="!edgeDraft.isLeaf" id="edge-condition-value" placeholder="value" [(ngModel)]="edgeDraft.value" (ngModelChange)="onValueInputChange($event)" style="flex:1" (keyup.enter)="confirmEdgeDraft()" />
          <input *ngIf="edgeDraft.isLeaf" id="edge-condition-value" placeholder="value" [(ngModel)]="edgeDraft.value" (ngModelChange)="onValueInputChange($event)" style="flex:1" (keyup.enter)="confirmEdgeDraft()" />
        </div>
        <div *ngIf="edgeDraftParseError" style="color:#b00020;font-size:12px;margin-top:6px">{{edgeDraftParseError}}</div>
        <div *ngIf="edgeDraft.isLeaf" style="margin-top:8px">
          <label>Output value</label>
          <input id="edge-output-value" placeholder="output" [(ngModel)]="edgeDraft.output" style="width:100%" (keyup.enter)="confirmEdgeDraft()" />
        </div>
        <div style="margin-top:8px">
          <button (click)="confirmEdgeDraft()">Confirm</button>
          <button (click)="cancelEdgeDraft()" style="margin-left:8px">Cancel</button>
        </div>
      </div>
      
    </div>
  
    <div style="margin-top:12px">
      <h4>Variables</h4>
      <div class="palette">
        <div class="var" draggable="true" (dragstart)="onVarDrag($event, 'age')">age</div>
        <div class="var" draggable="true" (dragstart)="onVarDrag($event, 'income')">income</div>
        <div class="var" draggable="true" (dragstart)="onVarDrag($event, 'country')">country</div>
      </div>
      <p style="font-size:12px;color:#666">Drag a variable into the canvas to add an input node.</p>
    </div>
  </div>
</div>

<!-- Export invalid modal -->
<div *ngIf="exportInvalidModalVisible" style="position:fixed;left:50%;top:120px;transform:translateX(-50%);background:#fff;border:1px solid #ccc;padding:12px;z-index:170;box-shadow:0 6px 20px rgba(0,0,0,0.12);width:420px;">
  <h4 style="margin:0 0 8px 0">Export Blocked ‚Äî DAG Incomplete</h4>
  <div style="font-size:13px;color:#333;margin-bottom:8px">Some non-leaf nodes do not lead to any leaf nodes. The graph must terminate at leaf nodes before exporting.</div>
  <div style="font-size:13px;color:#333;margin-bottom:8px">Please finish the graph for the following nodes:</div>
  <ul style="margin:8px 0;padding-left:18px;font-size:13px;color:#b00020">
    <li *ngFor="let id of exportInvalidNodes">{{id}}</li>
  </ul>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button (click)="focusFirstInvalid()">Focus First</button>
    <button (click)="closeExportInvalidModal()">Close</button>
  </div>
</div>

<!-- DOT roots modal -->
<div *ngIf="exportMultipleRootsModalVisible" style="position:fixed;left:50%;top:120px;transform:translateX(-50%);background:#fff;border:1px solid #ccc;padding:12px;z-index:175;box-shadow:0 6px 20px rgba(0,0,0,0.12);width:460px;">
  <h4 style="margin:0 0 8px 0">Export Blocked ‚Äî Multiple Roots</h4>
  <div style="font-size:13px;color:#333;margin-bottom:8px">DOT export requires exactly one root (entry) node. Found <strong>{{exportDOTRoots.length}}</strong> root nodes.</div>
  <div style="font-size:13px;color:#333;margin-bottom:8px">Please merge or remove extra roots. The following nodes are roots (no incoming edges):</div>
  <ul style="margin:8px 0;padding-left:18px;font-size:13px;color:#b00020">
    <li *ngFor="let id of exportDOTRoots">{{id}}</li>
  </ul>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button (click)="focusFirstRoot()">Focus First Root</button>
    <button (click)="closeExportMultipleRootsModal()">Close</button>
  </div>
</div>
  
<!-- Search modal: create variable name after clicking canvas -->
<div *ngIf="searchModalVisible" style="position:fixed;left:0;top:0;right:0;bottom:0;z-index:179"> 
  <div class="modal-overlay" (click)="closeSearchModal(true)" style="position:fixed;left:0;top:0;right:0;bottom:0;background:transparent"></div>
  <!-- attach drag start to the modal container so users can drag from any non-interactive area -->
  <div [ngStyle]="getSearchModalStyle()" (click)="$event.stopPropagation()" (mousedown)="startModalDrag($event)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="margin:0">Add Variable</h4>
    </div>
  <div style="font-size:13px;color:#333;margin-bottom:8px">Type a variable name to use for this node.</div>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <span style="font-size:16px;color:#666">üîç</span>
    <input id="search-input" [(ngModel)]="searchQuery" (ngModelChange)="onSearchQueryChange($event)" (keydown.enter)="confirmSearchModal()" (keydown.escape)="closeSearchModal(true)" placeholder="variable name" style="flex:1;min-width:0;padding:8px;border:1px solid #e6e6e6;border-radius:4px;" />
  </div>
  <div style="max-height:160px;overflow:auto;margin-bottom:8px">
    <ul style="list-style:none;margin:0;padding:0;border:1px solid #eee;border-radius:4px">
      <li *ngFor="let v of filteredVariables" (click)="selectVariable(v)" style="padding:8px;border-bottom:1px solid #f4f4f4;cursor:pointer">{{v}}</li>
      <li *ngIf="!filteredVariables.length" style="padding:8px;color:#666">No matches</li>
    </ul>
  </div>
  <div *ngIf="searchError" style="color:#b00020;font-size:12px;margin-bottom:8px">{{searchError}}</div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button (click)="confirmSearchModal()" [disabled]="!isSearchExactMatch">Confirm</button>
    <button (click)="closeSearchModal(true)">Cancel</button>
  </div>
</div>
