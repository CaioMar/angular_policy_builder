<div #rootContainer class="container" style="display:flex;align-items:stretch;height:auto;gap:0;box-sizing:border-box;">
  <div class="left-pane" style="flex:1;min-width:0;padding-right:12px">
    <div class="controls">
      <app-hamburger-menu (open)="onHamburgerOpen()"></app-hamburger-menu>
      <div id="cy" #cyContainer (drop)="onDrop($event)" (dragover)="onDragOver($event)"></div>
      <!-- SVG overlay: fallback visible line drawn on top during drag (pointer-events:none) -->
      <svg class="edge-overlay" [style.display]="isEdgeDragging ? 'block' : 'none'">
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L10,5 L0,10 z" fill="#0073bb" />
          </marker>
        </defs>
        <line [attr.x1]="getDragLineStart().x" [attr.y1]="getDragLineStart().y" [attr.x2]="dragCurrent.x" [attr.y2]="dragCurrent.y" stroke="#0073bb" stroke-width="3" stroke-opacity="0.95" stroke-dasharray="6,4" marker-end="url(#arrow)" />
      </svg>
      <!-- small settings gear in the canvas (discrete) -->
      <div class="cy-settings" style="position:absolute;right:18px;top:14px;z-index:190;">
        <button title="Canvas settings" (click)="toggleCanvasSettings($event)" style="background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,0.06);color:#999;font-size:16px;">
          ⚙
        </button>
        <div *ngIf="canvasSettingsVisible" style="position:absolute;right:0;top:38px;background:#fff;border:1px solid #ddd;box-shadow:0 6px 20px rgba(0,0,0,0.12);padding:10px;border-radius:6px;min-width:220px;z-index:200">
          <div style="font-weight:600;margin-bottom:6px">Canvas Settings</div>
          <div style="margin-bottom:8px;font-size:13px">
            <label style="display:block;margin-bottom:4px">Background</label>
            <select [(ngModel)]="bgPattern" (ngModelChange)="applyBackground()" style="width:100%">
              <option value="plain">Plain</option>
              <option value="dots">Dotted</option>
              <option value="grid">Grid</option>
            </select>
          </div>
          <div style="margin-bottom:8px;font-size:13px;">
            <label style="display:block;margin-bottom:4px">Background Color</label>
            <input type="color" [(ngModel)]="bgColor" (ngModelChange)="applyBackground()" style="width:40px;height:30px;padding:0;border:0;background:transparent" />
          </div>
          <div style="margin-bottom:8px;font-size:13px">
            <label style="display:block;margin-bottom:4px">Zoom level</label>
            <input type="range" min="0.2" max="3" step="0.01" [(ngModel)]="zoomLevel" (ngModelChange)="setZoomLevel($event)" style="width:100%" />
            <div style="font-size:12px;color:#666;margin-top:4px">{{zoomLevel | number:'1.2-2'}}×</div>
          </div>
        </div>
      </div>
    </div>

    <app-metadata-panel
      [selectedNode]="selectedNode"
      [selectedEdge]="selectedEdge"
      [lastSelectionSnapshot]="lastSelectionSnapshot"
      [metadataHeight]="metadataHeight"
      (startMetaResizerDrag)="startMetaResizerDrag($event)">
    </app-metadata-panel>
  </div>

  <!-- resizer between panes -->
  <div class="resizer" (mousedown)="startResizerDrag($event)" style="flex:0 0 8px;cursor:col-resize;background:transparent;user-select:none"></div>

    <div class="right-pane" [style.width.px]="rightPaneWidth" style="flex:0 0 auto;min-width:220px;max-width:720px;overflow:auto;padding-left:12px">
      <app-right-panel
        [selectedNode]="selectedNode"
        [selectedEdge]="selectedEdge"
        [edgeDraft]="edgeDraft"
        [conflictingEdges]="conflictingEdges"
        [exportInvalidNodes]="exportInvalidNodes"
        [exportDOTRoots]="exportDOTRoots"
        [canvasSettingsVisible]="canvasSettingsVisible"
        [bgPattern]="bgPattern"
        [bgColor]="bgColor"
        [zoomLevel]="zoomLevel"
        (addNode)="addNode()"
        (deleteSelected)="deleteSelected()"
        (updateSelectedEdge)="updateSelectedEdge()"
        (cancelEdgeEdit)="cancelEdgeEdit()"
        (confirmEdgeDraft)="confirmEdgeDraft()"
        (cancelEdgeDraft)="cancelEdgeDraft()"
        (replaceConflictsAndConfirm)="replaceConflictsAndConfirm()"
        (cancelConflictModal)="cancelConflictModal()"
        (requestExportJSON)="requestExportJSON()"
        (requestExportDOT)="requestExportDOT()"
        (focusFirstInvalid)="focusFirstInvalid()"
        (closeExportInvalidModal)="closeExportInvalidModal()"
        (focusFirstRoot)="focusFirstRoot()"
        (closeExportMultipleRootsModal)="closeExportMultipleRootsModal()"
        (toggleCanvasSettings)="toggleCanvasSettings($event)"
        (setZoomLevel)="setZoomLevel($event)"
        (applyBackground)="applyBackground()"
        (onValueInputChange)="onValueInputChange($event)"
        (onVarDrag)="onVarDrag($event.event, $event.name)">
      </app-right-panel>
    </div>
</div>

<!-- Search modal: create variable name after clicking canvas -->
<div *ngIf="searchModalVisible" style="position:fixed;left:0;top:0;right:0;bottom:0;z-index:179"> 
  <div class="modal-overlay" (click)="closeSearchModal(true)" style="position:fixed;left:0;top:0;right:0;bottom:0;background:transparent"></div>
  <!-- attach drag start to the modal container so users can drag from any non-interactive area -->
  <div [ngStyle]="getSearchModalStyle()" (click)="$event.stopPropagation()" (mousedown)="startModalDrag($event)">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <div [class.active]="(searchQuery && searchQuery.length>0) || searchHasFocus" style="display:flex;align-items:center;gap:8px;flex:1;max-width:520px;padding:4px 8px;border-radius:22px;background:white;box-sizing:border-box;border:1px solid rgb(204, 204, 204);">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="flex:0 0 auto;color:#6b7280">
        <path d="M11 4a7 7 0 1 0 0 14 7 7 0 0 0 0-14z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
      <input id="search-input" [(ngModel)]="searchQuery" (ngModelChange)="onSearchQueryChange($event)" (keydown.enter)="confirmSearchModal()" (keydown.escape)="closeSearchModal(true)" placeholder="Search Variables"
        (focus)="searchHasFocus = true" (blur)="searchHasFocus = false"
        style="flex:1;min-width:0;border:0;outline:none;padding:8px 6px;font-size:14px;background:transparent;color:inherit" />
      <button *ngIf="searchQuery && searchQuery.length" (click)="(searchQuery=''); onSearchQueryChange(''); $event.stopPropagation()" style="flex:0 0 auto;background:transparent;border:0;color:#6b7280;font-size:16px;cursor:pointer;padding:4px 6px;border-radius:12px">✕</button>
    </div>
  </div>
  <div style="max-height:160px;overflow:auto;margin-bottom:8px">
    <ul *ngIf="searchQuery && searchQuery.length>0" style="list-style:none;margin:0;padding:0;border-radius:4px;border:0;background:transparent">
      <li *ngFor="let v of filteredVariables" (click)="selectVariable(v)" style="padding:8px;background: white;cursor:pointer">{{v}}</li>
      <li *ngIf="!filteredVariables.length" style="padding:8px;color:#666">No matches</li>
    </ul>
  </div>
  <div *ngIf="searchError" style="color:#b00020;font-size:12px;margin-bottom:8px">{{searchError}}</div>
</div>
